<!DOCTYPE html>
<html>
<head>
    <title>视频时长检测工具</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        #status { margin-top: 10px; padding: 10px; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .warning { background-color: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <h1>视频时长检测</h1>
    <div>
        <video id="myVideo" controls crossorigin="anonymous" width="100%"></video>
        <p id="durationDisplay">视频加载中...</p>
        <div id="status">状态：正在检测视频时长...</div>
    </div>

<script>
    // 默认备选地址
    const DEFAULT_REDIRECT_URL = 'https://open.feishu.cn/anycross/trigger/callback/MDlmYTEyZDY1YWQyN2RkZjE4NmM0ZDE1ZjEyMWRiYjcx';
    
    // 从URL参数获取视频地址
    const urlParams = new URLSearchParams(window.location.search);
    const videoUrl = urlParams.get('videoUrl');
    
    // 获取来源地址（即打开此页面的地址）
    const referrer = document.referrer;
    
    // 确定跳转地址：优先使用来源地址，否则使用默认地址
    let redirectBaseUrl = referrer || DEFAULT_REDIRECT_URL;
    
    // 如果来源地址是当前页面（防止循环跳转），则使用默认地址
    if (redirectBaseUrl === window.location.href) {
        redirectBaseUrl = DEFAULT_REDIRECT_URL;
    }

    // 格式化时长为 HH:MM:SS
    function formatDuration(seconds) {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = Math.floor(seconds % 60);
        return [
            hours.toString().padStart(2, '0'),
            minutes.toString().padStart(2, '0'),
            secs.toString().padStart(2, '0')
        ].join(':');
    }

    // 更新状态显示
    function updateStatus(message, type = '') {
        const statusEl = document.getElementById('status');
        statusEl.textContent = message;
        statusEl.className = type;
    }

    // 跳转并携带时长参数
    function redirectWithDuration(durationSeconds) {
        // 创建跳转URL对象
        const redirectUrl = new URL(redirectBaseUrl);
        
        // 添加或更新参数
        redirectUrl.searchParams.set('duration', durationSeconds.toFixed(2));
        redirectUrl.searchParams.set('videoUrl', videoUrl);
        redirectUrl.searchParams.set('durationFormatted', formatDuration(durationSeconds));
        
        // 执行跳转
        window.location.href = redirectUrl.toString();
    }

    // ==================== 方案1：强制修改Referer加载视频 ====================
    async function tryLoadVideoWithCustomReferer() {
        updateStatus('尝试强制修改Referer加载视频...', 'warning');
        try {
            // 使用fetch获取视频数据（强制设置Referer）
            const response = await fetch(videoUrl, {
                headers: {
                    'Referer': 'https://www.gzsg.org/',
                },
            });
            if (!response.ok) throw new Error('Fetch请求失败');

            // 将视频数据转为Blob URL
            const blob = await response.blob();
            const blobUrl = URL.createObjectURL(blob);
            
            // 加载到video元素
            const video = document.getElementById('myVideo');
            video.src = blobUrl;
            
            // 等待元数据加载
            return new Promise((resolve) => {
                video.addEventListener('loadedmetadata', () => {
                    if (!isNaN(video.duration)) {
                        resolve(video.duration);
                    } else {
                        throw new Error('无法解析视频时长');
                    }
                });
                video.addEventListener('error', () => {
                    throw new Error('视频加载失败');
                });
            });
        } catch (error) {
            console.log('方案1失败:', error.message);
            return null;
        }
    }

    // ==================== 方案2：HEAD请求估算时长 ====================
    async function tryGetDurationViaHeadRequest() {
        updateStatus('尝试通过HEAD请求估算时长...', 'warning');
        try {
            const response = await fetch(videoUrl, {
                method: 'HEAD',
                headers: {
                    'Referer': 'https://www.gzsg.org/',
                },
            });
            if (!response.ok) throw new Error('HEAD请求失败');

            // 从Content-Length和码率估算（假设码率为1MB/s）
            const contentLength = response.headers.get('Content-Length');
            if (!contentLength) throw new Error('无Content-Length头');
            
            const duration = contentLength / (1024 * 1024); // 粗略估算（秒）
            return duration;
        } catch (error) {
            console.log('方案2失败:', error.message);
            return null;
        }
    }

    // ==================== 方案3：Range请求解析元数据 ====================
    async function tryGetDurationViaRangeRequest() {
        updateStatus('尝试通过Range请求解析元数据...', 'warning');
        try {
            // 请求视频前100KB（足够解析元数据）
            const response = await fetch(videoUrl, {
                headers: {
                    'Range': 'bytes=0-102400',
                    'Referer': 'https://www.gzsg.org/',
                },
            });
            if (!response.ok) throw new Error('Range请求失败');

            // 转为Blob并解析
            const blob = await response.blob();
            const blobUrl = URL.createObjectURL(blob);
            
            return new Promise((resolve) => {
                const tempVideo = document.createElement('video');
                tempVideo.src = blobUrl;
                tempVideo.onloadedmetadata = () => {
                    if (!isNaN(tempVideo.duration)) {
                        resolve(tempVideo.duration);
                    } else {
                        throw new Error('无法解析时长');
                    }
                };
                tempVideo.onerror = () => {
                    throw new Error('元数据解析失败');
                };
            });
        } catch (error) {
            console.log('方案3失败:', error.message);
            return null;
        }
    }

    // ==================== 主逻辑 ====================
    async function main() {
        if (!videoUrl) {
            updateStatus('未提供视频URL参数（使用?videoUrl=xxx）', 'error');
            return;
        }

        let duration = null;
        
        // 按顺序尝试三种方案
        duration = await tryLoadVideoWithCustomReferer();
        if (!duration) duration = await tryGetDurationViaRangeRequest();
        if (!duration) duration = await tryGetDurationViaHeadRequest();

        // 处理结果
        if (duration) {
            const formatted = formatDuration(duration);
            document.getElementById('durationDisplay').textContent = 
                `视频时长：${formatted}, 总秒数：${duration.toFixed(2)}秒`;
            updateStatus('检测完成，即将跳转...', 'success');
            setTimeout(() => redirectWithDuration(duration), 1000);
        } else {
            updateStatus('所有方法均失败，无法获取视频时长', 'error');
        }
    }

    // 启动
    main();
</script>
</body>
</html>
